// /js/index.js
// Tiny router + lazy loading for FireOps Calc

const app = document.getElementById('app');
const navButtons = Array.from(document.querySelectorAll('.navbtn'));
let currentView = null;    // { dispose?: () => void }
let currentName = null;

// Map data-view names → modules
const loaders = {
  calc:     () => import('./view.calc.js'),
  practice: () => import('./view.practice.js'),
  charts:   () => import('./view.charts.js'),
  settings: () => import('./view.settings.js'),
  // NEW Relay view
  relay:    () => import('./view.relay.js'),
};

async function show(viewName) {
  const loader = loaders[viewName];
  if (!loader) {
    console.warn('No loader for view:', viewName);
    return;
  }

  // Dispose old view if it exposes a dispose()
  if (currentView && typeof currentView.dispose === 'function') {
    try {
      currentView.dispose();
    } catch (err) {
      console.error('Error disposing view:', currentName, err);
    }
  }

  // Simple loading state
  if (app) {
    app.innerHTML = `
      <section class="card" style="padding:16px; text-align:center;">
        <div class="mini" style="opacity:.8">Loading ${viewName}…</div>
      </section>
    `;
  }

  try {
    const mod = await loader();

    if (!mod || typeof mod.render !== 'function') {
      console.error('View module missing render():', viewName, mod);
      if (app) {
        app.innerHTML = `
          <section class="card" style="padding:16px; color:#fee2e2; background:#450a0a;">
            Unable to load view: <b>${viewName}</b>
          </section>
        `;
      }
      return;
    }

    const result = await mod.render(app);
    currentView = result || {};
    currentName = viewName;
  } catch (err) {
    console.error('Failed to load view:', viewName, err);
    if (app) {
      app.innerHTML = `
        <section class="card" style="padding:16px; color:#fee2e2; background:#450a0a;">
          Error loading view: <b>${viewName}</b>
        </section>
      `;
    }
  }

  // Highlight active nav button
  navButtons.forEach(btn => {
    const v = btn.dataset.view;
    btn.classList.toggle('active', v === viewName);
  });

  // Remember last view
  try {
    localStorage.setItem('fireops.view', viewName);
  } catch (_) {}
}

// Wire up nav buttons
navButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const viewName = btn.dataset.view;
    if (!viewName || viewName === currentName) return;
    show(viewName);
  });
});

// Initial view (load last used if available)
let initial = 'calc';
try {
  const saved = localStorage.getItem('fireops.view');
  if (saved && loaders[saved]) {
    initial = saved;
  }
} catch (_) {}

show(initial);
