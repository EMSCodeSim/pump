workflows:
  ios_release:
    name: "iOS App Store build"
    max_build_duration: 60

    environment:
      groups:
        - appstore_connect       # your env group in Codemagic
      vars:
        XCODE_PROJECT: "ios/App/App.xcodeproj"
        XCODE_SCHEME: "App"

    scripts:
      - name: Install signing assets (p12 + provisioning profile)
        script: |
          set -e

          echo "Checking env varsâ€¦"
          if [ -z "$IOS_CERTIFICATE_P12_BASE64" ]; then
            echo "âŒ IOS_CERTIFICATE_P12_BASE64 is EMPTY"
            exit 1
          fi

          if [ -z "$IOS_PROVISION_PROFILE_BASE64" ]; then
            echo "âŒ IOS_PROVISION_PROFILE_BASE64 is EMPTY"
            exit 1
          fi

          if [ -z "$P12_PASSWORD" ]; then
            echo "âŒ P12_PASSWORD is EMPTY"
            exit 1
          fi

          echo "Decoding certificate and provisioning profileâ€¦"
          echo "$IOS_CERTIFICATE_P12_BASE64" | base64 --decode > certificate.p12
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode > provisioning.mobileprovision

          echo "Creating and unlocking temporary keychainâ€¦"
          KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"

          # Create a new keychain with empty password
          security create-keychain -p "" "$KEYCHAIN_PATH"

          # Make it the default keychain
          security default-keychain -s "$KEYCHAIN_PATH"

          # Unlock the keychain and keep it unlocked for a while
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"

          echo "Importing certificate into keychainâ€¦"
          security import certificate.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$P12_PASSWORD" \
            -A -t cert -f pkcs12 \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          echo "Listing keychains to confirm..."
          security list-keychains

          echo "Installing provisioning profileâ€¦"
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp provisioning.mobileprovision \
            ~/Library/MobileDevice/Provisioning\ Profiles/app.mobileprovision

          echo "âœ… Signing assets installed"

      - name: Build and export IPA (raw xcodebuild)
        script: |
          set -e

          echo "ðŸ”Ž Debug: where are we?"
          pwd
          echo "ðŸ”Ž Debug: listing ios/App:"
          ls -R ios/App || true

          ARCHIVE_PATH="$CM_BUILD_DIR/App.xcarchive"
          EXPORT_PATH="$CM_BUILD_DIR/ipa"

          echo "ðŸ”Ž Debug: listing schemes in project..."
          xcodebuild -project "$XCODE_PROJECT" -list || true

          echo "ðŸ”Ž Debug: showing build settings for scheme '$XCODE_SCHEME'..."
          xcodebuild -project "$XCODE_PROJECT" -scheme "$XCODE_SCHEME" -showBuildSettings || true

          echo "ðŸ“¦ Archiving with xcodebuildâ€¦"
          xcodebuild \
            -project "$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            clean archive \
            CODE_SIGN_STYLE=Manual \
            "CODE_SIGN_IDENTITY=Apple Distribution" \
            COMPILER_INDEX_STORE_ENABLE=NO

          echo "ðŸ“¤ Exporting IPAâ€¦"
          mkdir -p "$EXPORT_PATH"

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist export_options.plist \
            -exportPath "$EXPORT_PATH"

          echo "âœ… IPA export complete"
          ls -R "$EXPORT_PATH" || true

    artifacts:
      - $CM_BUILD_DIR/**/*.ipa
      - $CM_BUILD_DIR/App.xcarchive/**
